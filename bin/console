#!/usr/bin/env php
<?php

declare(strict_types=1);

const PATH_ROOT = __DIR__ . '/..';
const PATH_CORE = PATH_ROOT . '/src';
const PATH_APP = PATH_ROOT . '/app';
const PATH_CONFIG = PATH_ROOT . '/config';
const PATH_CACHE = PATH_ROOT . '/cache';
const PATH_TEMPLATE = PATH_ROOT . '/templates';
const PATH_PUBLIC = PATH_ROOT . '/public';
const PATH_VENDOR = PATH_ROOT . '/vendor';
const PATH_LOG = PATH_ROOT . '/logs/app.log';
const PATH_VAR = PATH_ROOT . '/var';
const PATH_VAR_CONFIG = PATH_VAR . '/config';
const PATH_MIGRATIONS = PATH_ROOT . '/migrations';

require __DIR__ . '/../vendor/autoload.php';

use SimpleMVC\CLI\BaseCommand;
use SimpleMVC\Core\Bootstrap;
use SimpleMVC\Discovery\CommandDiscovery;

$handler = new \Whoops\Handler\PlainTextHandler();
$whoops = new \Whoops\Run();
$whoops->pushHandler($handler);

// Load extra commands from config cache
$extraCommands = CommandDiscovery::discover(__DIR__ . '/../src/CLI');

// Scan for commands in app/Command and add extra commands from config
$commands = CommandDiscovery::discover(__DIR__ . '/../app/Command');

$commands = array_merge($commands, $extraCommands);

// Sort the commands by name
usort($commands, static fn($a, $b) => strcmp($a['name'], $b['name']));

// Build a map: command name => class
$commandMap = [];
foreach ($commands as $cmd) {
    $commandMap[$cmd['name']] = $cmd;
}

// Parse argv
$args = $argv ?? $_SERVER['argv'] ?? [];
$script = array_shift($args);
$commandName = array_shift($args);

// Show help if no command given
if (!$commandName || !isset($commandMap[$commandName])) {
    echo "Available commands:\n";
    foreach ($commandMap as $cmd) {
        echo "  {$cmd['name']}\t{$cmd['description']}\n";
    }
    exit(1);
}

$container = Bootstrap::buildContainer(PATH_CACHE);

// Instantiate and run the command
$cmdClass = $commandMap[$commandName]['class'];
/** @var BaseCommand $command */
$command = new $cmdClass($container);

if (in_array('--help', $args, true)) {
    echo $command->getHelp() . PHP_EOL;
    exit(0);
}

exit($command->execute($argv));
